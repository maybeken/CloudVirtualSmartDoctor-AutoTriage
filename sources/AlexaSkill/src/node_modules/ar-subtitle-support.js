var AWS = require('aws-sdk');
var s3 = new AWS.S3();

// Configurations
const cfg = require(__base+'config');

// Lanuages Support
var extend = require('util')._extend;
var common = require(__base+'lang/common');
var scripts = require(__base+'lang/scripts');

module.exports = function () {
    var languageStrings = {
        "zh-HK": extend(common.COMMON_ZH_HK, scripts.SCRIPTS_ZH_HK),
        "en-GB": extend(common.COMMON_EN_GB, scripts.SCRIPTS_EN_GB)
    };

    var _this;
    var subtitle = "";
    var callback = function(){};

    var args = arguments;
    for(var i=0; i<args.length; i++){
        if(typeof args[i] === "string"){
            if(languageStrings["zh-HK"][args[i]] !== undefined){
                subtitle += languageStrings["zh-HK"][args[i]];
            }else if(languageStrings["en-GB"][args[i]] !== undefined){
                subtitle += languageStrings["en-GB"][args[i]];
            }else{
                subtitle += args[i];
            }
        }else if(typeof args[i] === "function"){
            callback = args[i];
        }else if(typeof args[i] === "object"){
            _this = args[i];
        }
    }

    subtitle = subtitle.replace(/<break time=\"0.1s\" \/>/g, "");

    var params = {Bucket: cfg.AWS.SUBTITLE_S3_BUCKET, Key: 'subtitle.txt', Body: subtitle, ACL: 'public-read', ContentType: 'text/plain'};

    s3.upload(params, function(err, data) {
        if(err){
            console.log("Error: S3 Upload Failure!");
        }else{
            console.log("Subtitle output: "+subtitle);
        }

        callback(_this);
    });
};
